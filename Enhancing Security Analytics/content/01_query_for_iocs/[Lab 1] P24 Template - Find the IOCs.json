{"version":"5","defaultTimeframe":{"from":"now-6h","to":"now","details":{"from":{"type":"expression","normalized":"now-6h","date":"2023-12-13T00:27:22.789Z"},"to":{"type":"expression","normalized":"now","date":"2023-12-13T06:27:22.789Z"}}},"sections":[{"id":"84e2c0d0-bd85-471a-9958-d238be2b485a","type":"markdown","markdown":"# **Lab Exercise: Hunt for any activity from the given known IOCs**\n\n**Grail is a next generation data lakehouse storage. Users and Analysts can use the powerful DQL to hunt for data ingested into Grail.**\n\n**You are working for Y, former unguard, a very popular social media company. The Cybersecurity team of Y has reached out to you as they have received information about a ransomeware gang that is targerting large organizations and tries to exfiltrate data and threatens to publish it on the dark web, unless they get payed. The Cybersecurity team has received a list of Indicators of Compromise (IOC) and asks you the verify if you can find any evidence of an attempted attack.**"},{"id":"b5487323-30c5-40b2-b0c0-b8f89220cff7","type":"markdown","markdown":"# Step 1: Write a simple DQL to fetch all logs for a certain duration (Example 2 hours)\n\nTask:\n\n1. Use fetch query to pull logs for a specific duration.\n2. Find the field that has information about the source of logs."},{"id":"74557e2b-fbb7-4416-9651-47fd6deb6382","type":"dql","showTitle":false,"state":{"input":{"value":"fetch logs","timeframe":{"from":"now-2h","to":"now","details":{"from":{"type":"expression","normalized":"now-2h","date":"2023-12-11T01:17:22.263Z"},"to":{"type":"expression","normalized":"now","date":"2023-12-11T03:17:22.263Z"}}}},"davis":{"includeLogs":true,"davisVisualization":{"isAvailable":true}},"visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{}},"singleValue":{"showLabel":true,"label":"","prefixIcon":"","autoscale":true,"alignment":"center","isBackgroundThresholdActive":false},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"firstVisibleRowIndex":0,"columnWidths":{}}}}},{"id":"b7a31e11-b204-45be-aa55-3e6efa186aba","type":"markdown","markdown":"# Step 2: Filter events to show only Windows Events\n\n**Tasks:**\n1. Continue from above query block\n2. To start with, write simple filter to display results from Windows.\n3. Use the log.source field with contains operator to achieve this.\n\n[Need Help?](https://docs.dynatrace.com/docs/observe-and-explore/logs/log-management-and-analytics/logs-on-grail-examples#logexample3)"},{"id":"77de892e-eeb1-4352-a2fc-3d76e47615c2","type":"dql","title":"","showTitle":false,"state":{"input":{"value":"// Refer to documentation and guide for help links if required.","timeframe":{"from":"now-6h","to":"now","details":{"from":{"type":"expression","normalized":"now-6h","date":"2023-12-13T00:27:22.789Z"},"to":{"type":"expression","normalized":"now","date":"2023-12-13T06:27:22.789Z"}}}},"state":"idle","davis":{"includeLogs":true,"davisVisualization":{"isAvailable":true}},"visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{}},"singleValue":{"showLabel":true,"label":"","prefixIcon":"","autoscale":true,"alignment":"center"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"firstVisibleRowIndex":0,"columnWidths":{}}}}},{"id":"f9536f0d-1c64-4657-8c0b-f143faf96ded","type":"markdown","markdown":"# Step 3: Further filter the events to find out any login attempts\n\n**Tasks:**\n1. Look for log content to match any relevant string.\n2. Try looking for matches with string incorrect password, failed login, bad password, user not found, authentication failure.\n\n*Pro Exercise: Modify the query to look for authentication failures from non-windows servers and log sources*\n\n[Need Help?](https://docs.dynatrace.com/docs/platform/grail/dynatrace-query-language/functions/string-functions#contains)"},{"id":"0064f723-17c4-41da-bb74-bad72ed5f0c3","type":"dql","showTitle":false,"state":{"input":{"value":"","timeframe":{"from":"now-6h","to":"now","details":{"from":{"type":"expression","normalized":"now-6h","date":"2023-12-13T00:27:22.789Z"},"to":{"type":"expression","normalized":"now","date":"2023-12-13T06:27:22.789Z"}}}},"state":"idle","davis":{"includeLogs":true,"davisVisualization":{"isAvailable":true}}}},{"id":"ace88f32-68b4-4f61-9f94-a69659f2f9fb","type":"markdown","markdown":"# Step 4: Modify the displayed results to show only the fields/details of interest from IOCs.\n\n**Task:**\n\n1. Display only necessary fields example username, ip address, hostname, timestamp and any other information that is of interest.\n2. Try adding filter to look for IP address check from the given IOC list to see if there are any matches\n3. Use the command summarize with count and by operators to achieve this.\n\n*Note: You might not see any results for this. This could be because the malicious actor has not progressed to reach the windows machines at this moment. This is quite common in Security Analytics. The ultimate goal is to find out how far the attack has progressed and what is the attack path taken.*\n\n[Need Help with fields command?](https://docs.dynatrace.com/docs/platform/grail/dynatrace-query-language/commands/old-index#fields)\n\n[Search for an IP documentation](https://docs.dynatrace.com/docs/platform/grail/dynatrace-query-language/functions/network-functions#ipIn)\n\n**Hint: You might not see any results for this search. In Security Analytics, this means the attacker has not reached windows servers yet. It could be because the attacker might still be learning the environment and yet to pivot their way around.**"},{"id":"aedc536d-2038-48cb-845c-483011d10c80","type":"dql","showTitle":false,"state":{"input":{"value":"","timeframe":{"from":"now-6h","to":"now","details":{"from":{"type":"expression","normalized":"now-6h","date":"2023-12-13T00:27:22.789Z"},"to":{"type":"expression","normalized":"now","date":"2023-12-13T06:27:22.789Z"}}}},"state":"idle","davis":{"includeLogs":true,"davisVisualization":{"isAvailable":true}}}},{"id":"855c66b2-839a-456a-a9dd-1d44453daa3c","type":"markdown","markdown":"*Note: You can duplicate the above query block, add filters further based on the usecase requirement. Depends on the usecase, the filters could be to look for non administrator user logins, logins from any specific ip series, or login from a specific ip address*"},{"id":"fb7d9337-bb42-44ae-8e72-a98afd425e45","type":"markdown","markdown":"# Step 5: Hunt for any activity from the given known IOCs outside Windows\n\n**You can start the search with one IP address and later add additional IP addresses as you go to expand the threat hunting scope. We are looking to find any traces of these IPs outside Windows events**\n\n**Task:**\n1. Start with fetching logs first. Use the samples from above exercise.\n2. Search on content field to look for any match of any one of the IP addresses.\n3. If no activities found for IP, try expanding time range to a larger duration."},{"id":"30305ed3-0e8e-436d-8b92-458389802f83","type":"dql","showTitle":false,"state":{"input":{"value":"","timeframe":{"from":"now-6h","to":"now","details":{"from":{"type":"expression","normalized":"now-6h","date":"2023-12-13T00:27:22.789Z"},"to":{"type":"expression","normalized":"now","date":"2023-12-13T06:27:22.789Z"}}}},"state":"idle","davis":{"includeLogs":true,"davisVisualization":{"isAvailable":true}}}},{"id":"9f13107d-2fee-4e76-b648-48c2f63e2cb1","type":"markdown","markdown":"**Now that you have some activities detected from the IP address given, let's find out where these activities are seen.**\n\n**Task:**\n\n1. Duplicate the above query block, further see a Summarized list to see what all sources generated logs for this IP. (click on column name and select summarize to get a summary automatically without writing query)\n2. Refer to lab guide or Dynatrace documentation for help to see how to get a summary on a specific field."},{"id":"6ddb91e8-4789-48c5-bcc2-07142c55e8e8","type":"dql","showTitle":false,"state":{"input":{"value":"","timeframe":{"from":"now-6h","to":"now","details":{"from":{"type":"expression","normalized":"now-6h","date":"2023-12-13T00:27:22.789Z"},"to":{"type":"expression","normalized":"now","date":"2023-12-13T06:27:22.789Z"}}}},"state":"idle","davis":{"includeLogs":true,"davisVisualization":{"isAvailable":true}}}},{"id":"5f2fa372-88d0-47bb-81f5-fd4e9fa51863","type":"markdown","markdown":"**The list of log sources is a great start to dive deeper into analytics.**\n\n**Task:**\n\n1. Pick a log source that is of interest. Find a log source name that is a firewall or WAF or EDR to see activities across the network.\n2. Once you found a log source, add a filter on your DQL to show logs from that specific log source.\n3. You can use log.source field to filter down to single source."},{"id":"02ceeafa-6114-4629-b978-e3bc0e557805","type":"dql","showTitle":false,"state":{"input":{"value":"","timeframe":{"from":"now-6h","to":"now","details":{"from":{"type":"expression","normalized":"now-6h","date":"2023-12-13T00:27:22.789Z"},"to":{"type":"expression","normalized":"now","date":"2023-12-13T06:27:22.789Z"}}}},"state":"idle","davis":{"includeLogs":true,"davisVisualization":{"isAvailable":true}}}},{"id":"ce16dbfb-5943-4028-8848-88681ec6878e","type":"markdown","markdown":"**Now that we have logs from a network device, let's expand the search to see all the shared IPs**\n\n**Task:**\n1. Expand the search, add additional filters to look for more IPs from the shared IOC list.\n2. Use logical operators to duplicate ip filter block to add more IPs."},{"id":"2c730359-36a5-47c3-bf87-3cde03eccf37","type":"dql","showTitle":false,"state":{"input":{"value":"","timeframe":{"from":"now-6h","to":"now","details":{"from":{"type":"expression","normalized":"now-6h","date":"2023-12-13T00:27:22.789Z"},"to":{"type":"expression","normalized":"now","date":"2023-12-13T06:27:22.789Z"}}}},"davis":{"includeLogs":true,"davisVisualization":{"isAvailable":true}},"visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{}},"singleValue":{"showLabel":true,"label":"","prefixIcon":"","autoscale":true,"alignment":"center"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"firstVisibleRowIndex":0,"columnWidths":{}}},"state":"idle"}},{"id":"f708850c-4a6b-47c6-be53-a08ebb80e1b1","type":"markdown","markdown":"# End of Lab Exercise 1\n\n--- "},{"id":"aa47cd4c-ac6f-45d6-8659-3bbd39501846","type":"markdown","markdown":"# *Additional PRO tips for advanced IP address hunting. (To be continued after Lab 2)*\n\n**Task:**\n1. Look for logs from fortigate firewall source.\n2. By manually reviewing the content field in logs, you can see the IP address comes in a field called srcip=.\n3. Extracting this will help you to run advanced and faster searches.\n\n    *Note: Use the expertise gained from Lab 2 about DPL here to extract the fields.*\n\n4. Write a simple DPL to extract IP address and assign to field (Example: srcIP)."},{"id":"7c30b2e0-5011-408c-a5a6-9b45b90b8e36","type":"dql","showTitle":false,"state":{"input":{"value":"","timeframe":{"from":"now-6h","to":"now","details":{"from":{"type":"expression","normalized":"now-6h","date":"2023-12-13T00:27:22.789Z"},"to":{"type":"expression","normalized":"now","date":"2023-12-13T06:27:22.789Z"}}}},"state":"idle","davis":{"includeLogs":true,"davisVisualization":{"isAvailable":true}}}},{"id":"ceb7f0bb-f1f7-444c-bc15-6bc25a7f32ae","type":"markdown","markdown":"**Now that you have the IP field extracted on a separate field, you can run advanced analytics on it**\n\n**Task:**\n1. Run the search on this extracted field for the given CIDR range."},{"id":"ebe5d68f-8900-45da-b7eb-0a4ee0a0c54b","type":"dql","showTitle":false,"state":{"input":{"value":"","timeframe":{"from":"now-6h","to":"now","details":{"from":{"type":"expression","normalized":"now-6h","date":"2023-12-13T00:27:22.789Z"},"to":{"type":"expression","normalized":"now","date":"2023-12-13T06:27:22.789Z"}}}},"state":"idle","davis":{"includeLogs":true,"davisVisualization":{"isAvailable":true}}}},{"id":"261f31b8-8560-4d48-9c5d-34daecc4d18f","type":"markdown","markdown":"# End of Optional Additional Exercise"}]}